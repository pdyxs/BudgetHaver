<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title>Budget Haver</title>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/fontawesome-webfonts.css">
    <link rel="stylesheet" href="css/budget.css">
    <script src="js/jquery.slim.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/lodash.js"></script>
    <script type="text/javascript" src="js/localforage.min.js"></script>
    <script type="text/javascript" src="js/moment.js"></script>
  </head>
  <body>
    <div class="text-center">
      <h1 class="text-small text-muted my-3 title-content">Budget Haver</h1>
      <div class="container">
        <div class="card text-light bg-info">
          <div class="card-header">
            <h3 class="card-title mb-0">You have</h3>
          </div>
          <div class="card-body">
            <h2 class="display-3" id="moneyDisplay"></h2>
          </div>
        </div>
        <div class="text-small text-muted">
          You get $<span id="dailyBudget">0</span> per day<br />
          Last added: <span id="lastUpdated"></span>
        </div>

        <!-- Bottom Section -->
        <!-- Menu -->
        <ul class="nav nav-tabs mt-2" id="tabMenu" role="tablist">
          <li class="nav-item">
            <a class="nav-link px-2-5 px-xs-3" id="spend-tab" data-toggle="tab" href="#spend"
                                role="tab" aria-controls="spend">
              <i class="far fa-dollar-sign"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link px-2-5 px-xs-3" id="goal-tab" data-toggle="tab" href="#goal"
                                role="tab" aria-controls="goal">
              <i class="far fa-trophy"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link px-2-5 px-xs-3" id="history-tab" data-toggle="tab" href="#history"
                                role="tab" aria-controls="history">
              <i class="far fa-history"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link px-2-5 px-xs-3" id="chart-tab" data-toggle="tab" href="#chart"
                                role="tab" aria-controls="chart">
              <i class="far fa-chart-line"></i>
            </a>
          </li>
          <li class="nav-item ml-auto">
            <a class="nav-link px-2-5 px-xs-3" id="settings-tab" data-toggle="tab" href="#settings"
                                role="tab" aria-controls="settings">
              <i class="far fa-cog"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link px-2-5 px-xs-3" id="help-tab" data-toggle="tab" href="#help"
                                role="tab" aria-controls="help">
              <i class="far fa-question"></i>
            </a>
          </li>
        </ul>

        <!-- Content -->
        <div class="card border-top-0 rounded-top-0 tab-content mb-3">

          <!-- Spend -->
          <div class="card-body tab-pane fade" role="tabpanel" id="spend" aria-labelledby="spend-tab">
            <div class="input-group rounded-bottom-0">
              <div class="input-group-prepend">
                <span class="input-group-text">$</span>
              </div>
              <input id="spendMoneyInput" type="number" pattern="-?\d+\.\d*" class="form-control" placeholder="0.00" />
            </div>
            <div class="progress mb-2 rounded-top-0">
              <div class="progress-bar bg-success" role="progressbar" id="spendingBar"
                style="width: 100%"></div>
            </div>
            <div class="mb-3">
              <select id="currencySelector" class="custom-select">
                <option value="1" selected>AUD</option>
                <option value="0.71">USD</option>
                <option value="2250">Colombian Peso</option>
                <option value="0.62">Euro</option>
              </select>
              <div id="currencyConverter" class="text-small text-muted">
                = <span id="convertedCurrency">32</span> AUD
              </div>
            </div>
            <button class="btn btn-lg btn-danger" id="spendButton" disabled>Spend Money!</button>
          </div>

          <!-- Goal -->
          <div class="card-body tab-pane fade text-left" role="tabpanel" id="goal" aria-labelledby="goal-tab">
            <div class="form-group">
              <label for="goalAmountInput" class="mb-0">I need</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">$</span>
                </div>
                <input readonly type="number" pattern="-?\d+\.\d*" class="form-control" id="goalAmountInput" placeholder="0">
                <div class="input-group-append">
                  <button class="btn btn-danger unlock-edit-button" target="#goalAmountInput">
                    <i class="far fa-edit locked"></i>
                    <i class="far fa-lock unlocked"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="goalDescriptionInput" class="mb-0">for</label>
              <div class="input-group">
                <input readonly type="text" pattern="-?\d+\.\d*" class="form-control" id="goalDescriptionInput" placeholder="something">
                <div class="input-group-append">
                  <button class="btn btn-danger unlock-edit-button" target="#goalDescriptionInput">
                    <i class="far fa-edit locked"></i>
                    <i class="far fa-lock unlocked"></i>
                  </button>
                </div>
              </div>
            </div>

            <p class="mb-0">
              Progress:
            </p>
            <div class="progress mb-2">
              <div class="progress-bar bg-success" role="progressbar" id="goalProgress"
                style="width: 0%"></div>
            </div>

          </div>

          <!-- History -->
          <div class="card-body tab-pane fade text-left py-0 px-0" role="tabpanel" id="history" aria-labelledby="history-tab">
            <table class="table m-0">
              <thead>
                <tr>
                  <th class="border-top-0">When</th>
                  <th class="border-top-0">How much</th>
                </tr>
              </thead>
              <tbody id="historyList">
              </tbody>
            </table>
          </div>

          <!-- Chart -->
          <div class="card-body tab-pane fade text-left" role="tabpanel" id="chart" aria-labelledby="chart-tab">
            <svg id="chart">
            </svg>
          </div>

          <!-- Settings -->
          <div class="card-body tab-pane fade text-left" role="tabpanel" id="settings">
            <div class="form-group">
              <label for="balanceOverrideInput">Override Balance</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">$</span>
                </div>
                <input readonly type="number" pattern="-?\d+\.\d*" class="form-control" id="balanceOverrideInput" placeholder="0">
                <div class="input-group-append">
                  <button class="btn btn-danger unlock-edit-button" target="#balanceOverrideInput">
                    <i class="far fa-edit locked"></i>
                    <i class="far fa-lock unlocked"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="dailyBudgetInput">Daily Budget</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">$</span>
                </div>
                <input readonly type="number" pattern="\d*" class="form-control" id="dailyBudgetInput" placeholder="0">
                <div class="input-group-append">
                  <button class="btn btn-danger unlock-edit-button" target="#dailyBudgetInput">
                    <i class="far fa-edit locked"></i>
                    <i class="far fa-lock unlocked"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Help -->
          <div class="card-body tab-pane fade text-left" role="tabpanel" id="help">
            <p><span class="title-content font-italic"></span> is a minimalistic budgeting
            app, designed to force you to make everyday spending decisions consciously.</p>
            <p>To use it, first choose a daily budget in the <i class="far fa-cog"></i> Settings tab.
              This amount will be added to your balance each day.</p>
            <p>Then, whenever you spend money, log it in the <i class="far fa-dollar-sign"></i> Spend tab.
              You should log this at the point of decision (so if some of the money will be automatically
              paid later, put it in when you set that up).</p>
            <p>Finally, take your balance seriously. Going below 0 is bad.</p>
            <p>Things you shouldn't log:
              <ul>
                <li>Recurring costs - these affect your daily budget</li>
                <li>Savings - just lower your daily budget to start saving</li>
                <li>ATM Withdrawals - you still have the money!</li>
              </ul>
            </p>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/currencies.js"></script>
    <script type="text/javascript">
      const defaultSettings = {
        money: 200,
        lastUpdated: moment().valueOf(),
        budget: 65,
        currency: 1,
        currentTab: "#help",
        goalAmount: 0,
        goalDescription: ""
      };

      const title = "Budget Haver";

      var currencyFormatter = new Intl.NumberFormat('en-AU', {
        style: 'currency',
        currency: 'AUD',
        minimumFractionDigits: 2
      });

      var settings = {};
      var spendHistory = [];

      function update() {
        localforage.setItem('settings', settings).then(() => {
          $("#dailyBudget").html(settings.budget);
          $("#moneyDisplay").html(currencyFormatter.format(settings.money));
          $("#lastUpdated").html(moment(settings.lastUpdated).format("D MMMM YY"));
          $("#currencySelector").val(settings.currency);
          $("#currencyConverter").toggleClass('d-none', settings.currency == 1);
          $('#balanceOverrideInput').val(settings.money.toFixed(2));
          $('#goalAmountInput').val(settings.goalAmount);
          $('#goalDescriptionInput').val(settings.goalDescription);

          var goalProgress = settings.goalAmount == 0 ? 0 :
            Math.min(1, Math.max(0, settings.money / settings.goalAmount));
          var goalBar = $('#goalProgress');
          goalBar.attr("style", `width: ${goalProgress * 100}%`);
          goalBar.toggleClass("bg-success", goalProgress == 1);
          goalBar.toggleClass("bg-warning", goalProgress > 0.5 && goalProgress < 1);
          goalBar.toggleClass("bg-danger", goalProgress < 0.5);

          updateCurrency();
        });
      }

      function updateCurrency() {
        setTimeout(function () {
          var val = $("#spendMoneyInput").val();
          var inAud = val / settings.currency;
          var percentLeft = settings.money < 0 ? -1 : (settings.money - inAud) / settings.money;

          $("#convertedCurrency").html(currencyFormatter.format(inAud));
          var spendButton = $("#spendButton");
          spendButton.attr("disabled", val == 0);
          spendButton.toggleClass("btn-success", percentLeft > 0.5);
          spendButton.toggleClass("btn-warning", percentLeft > 0 && percentLeft <= 0.5);
          spendButton.toggleClass("btn-danger", percentLeft <= 0);

          var spendingBar = $("#spendingBar");
          spendingBar.attr("style", `width: ${Math.max(0, 100 * percentLeft)}%`);
          spendingBar.toggleClass("bg-success", percentLeft > 0.5);
          spendingBar.toggleClass("bg-warning", percentLeft > 0 && percentLeft <= 0.5);
          spendingBar.toggleClass("bg-danger", percentLeft <= 0);

          $("#spendMoneyInput").toggleClass("text-danger", percentLeft < 0);
        }, 0.01);
      }

      function addHistory(amount) {
        spendHistory.push({
          date: moment().valueOf(),
          amount: amount
        });
        updateHistory();
      }

      function updateHistory() {
        localforage.setItem('history', spendHistory).then(() => {
          var list = $('#historyList');
          list.empty();
          var hist = _.reverse(_.takeRight(spendHistory, 5));
          for (var i = 0; i != hist.length; ++i) {
            var h = hist[i];
            var row = $("<tr/>").appendTo(list);
            $("<td/>").appendTo(row)
                      .html(moment(h.date).calendar());
            $("<td/>").appendTo(row)
                      .html(currencyFormatter.format(h.amount));
          }
        });
      }

      function setupHistory(hist) {
        spendHistory = hist || [];
        updateHistory();
      }

      function setup(set) {
        var today = moment().startOf("day");
        var lastUpdated = moment(set.lastUpdated).startOf("day");

        var money = set.money + today.diff(lastUpdated, 'days') * set.budget;

        settings = {
          money: money,
          lastUpdated: moment().valueOf(),
          budget: set.budget,
          currency: set.currency || 1,
          currentTab: set.currentTab || defaultSettings.currentTab,
          goalAmount: set.goalAmount || defaultSettings.goalAmount,
          goalDescription: set.goalDescription || defaultSettings.goalDescription
        };

        update();

        //setup listeners
        $("#currencySelector").on('change', (evt) => {
          settings.currency = evt.target.value;
          update();
        });

        $("#spendMoneyInput").on('keyup', (evt) => {
          updateCurrency();
        });

        $("#spendButton").click(() => {
          spending = $("#spendMoneyInput").val() / settings.currency;
          settings.money -= spending;
          $("#spendMoneyInput").val('');
          update();
          addHistory(spending);
        });

        $(`#tabMenu a[href="${settings.currentTab}"]`).tab('show');

        $('#tabMenu a').on('click', function (e) {
          settings.currentTab = $(this).attr('href');
          update();
        });

        $('#dailyBudgetInput').val(settings.budget);

        $('#dailyBudgetInput').on('keyup', (evt) => {
          setTimeout(function () {
            settings.budget = $('#dailyBudgetInput').val();
            update();
          }, 0.01);
        });

        $('#balanceOverrideInput').on('keyup', (evt) => {
          setTimeout(function () {
            var newVal = Number($('#balanceOverrideInput').val());
            if (_.isNumber(newVal)) {
              settings.money = newVal;
            }
            update();
          }, 0.01);
        });

        $('#goalAmountInput').on('keyup', (evt) => {
          setTimeout(function () {
            var newVal = Number($('#goalAmountInput').val());
            if (_.isNumber(newVal)) {
              settings.goalAmount = newVal;
            }
            update();
          }, 0.01);
        });

        $('#goalDescriptionInput').on('keyup', (evt) => {
          setTimeout(function () {
            settings.goalDescription = $('#goalDescriptionInput').val();
            update();
          }, 0.01);
        });

        $(".title-content").html(title);

        $(".unlock-edit-button").on('click', (evt) => {
          var button = $(evt.currentTarget);
          var input = $(button.attr('target'));
          var isEditing = !input.attr('readonly');
          input.attr('readonly', isEditing);
          button.toggleClass('editing', !isEditing);
        });
      }

      $(document).ready(() => {
        localforage.getItem('settings').then(settings => {
          setup(settings || defaultSettings);
        });

        localforage.getItem('history').then(h => {
          setupHistory(h);
        });
      });
    </script>
  </body>
</html>
