<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title>Budget Haver</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script type="text/javascript" src="js/localforage.min.js"></script>
    <script type="text/javascript" src="js/moment.js"></script>
  </head>
  <body>
    <div class="text-center">
      <h1 class="text-small text-muted my-3">Budget Haver</h1>
      <div class="container">
        <div class="card text-light bg-info">
          <div class="card-header">
            <h3 class="card-title mb-0">You have</h3>
          </div>
          <div class="card-body">
            <h2 class="display-3" id="moneyDisplay"></h2>
          </div>
        </div>
        <div class="text-small text-muted">
          You get $<span id="dailyBudget">0</span> per day<br />
          Last added: <span id="lastUpdated"></span>
        </div>
        <div class="card mt-4">
          <div class="card-header">
            <h4 class="card-title mb-0">Spend</h3>
          </div>
          <div class="card-body">
            <div class="input-group mb-2">
              <div class="input-group-prepend">
                <span class="input-group-text">$</span>
              </div>
              <input id="spendMoneyInput" type="number" pattern="-?\d+\.\d*" class="form-control" placeholder="0.00" />
            </div>
            <div class="mb-3">
              <select id="currencySelector" class="custom-select">
                <option value="1" selected>AUD</option>
                <option value="0.71">USD</option>
                <option value="2250">Colombian Peso</option>
                <option value="0.62">Euro</option>
              </select>
              <div id="currencyConverter" class="text-small text-muted">
                = <span id="convertedCurrency">32</span> AUD
              </div>
            </div>
            <button class="btn btn-lg btn-danger" id="spendButton" disabled>Spend Money!</button>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript">
      const defaultSettings = {
        money: 200,
        lastUpdated: moment().valueOf(),
        budget: 65,
        currency: 1
      };

      var currencyFormatter = new Intl.NumberFormat('en-AU', {
        style: 'currency',
        currency: 'AUD',
        minimumFractionDigits: 2
      });

      var settings = {};

      function update() {
        localforage.setItem('settings', settings).then(() => {
          $("#dailyBudget").html(settings.budget);
          $("#moneyDisplay").html(currencyFormatter.format(settings.money));
          $("#lastUpdated").html(moment(settings.lastUpdated).format("D MMMM YY"));
          $("#currencySelector").val(settings.currency);
          $("#currencyConverter").toggleClass('d-none', settings.currency == 1);
          updateCurrency();
        });
      }

      function updateCurrency() {
        setTimeout(function () {
          var val = $("#spendMoneyInput").val();
          $("#convertedCurrency").html(currencyFormatter.format(val / settings.currency));
          $("#spendButton").attr("disabled", val == 0);
        }, 0.01);
      }

      function setup(set) {
        var today = moment().startOf("day");
        var lastUpdated = moment(set.lastUpdated).startOf("day");

        var money = set.money + today.diff(lastUpdated, 'days') * set.budget;

        settings = {
          money: money,
          lastUpdated: moment().valueOf(),
          budget: set.budget,
          currency: set.currency || 1
        };

        update();

        //setup listeners
        $("#currencySelector").on('change', (evt) => {
          settings.currency = evt.target.value;
          update();
        });

        $("#spendMoneyInput").on('keyup', (evt) => {
          updateCurrency();
        });

        $("#spendButton").click(() => {
          settings.money -= $("#spendMoneyInput").val() / settings.currency;
          $("#spendMoneyInput").val('');
          update();
        });
      }

      $(document).ready(() => {
        localforage.getItem('settings').then(settings => {
          setup(settings || defaultSettings);
        });
      });
    </script>
  </body>
</html>
